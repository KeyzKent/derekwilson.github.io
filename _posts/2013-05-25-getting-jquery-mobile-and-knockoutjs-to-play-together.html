---
layout: post
title: "Getting jQuery Mobile and knockout.js to play together"
date: 2013-05-25 23:15:00 +1200
published: true
tags: ["Android", "Development", "JavaScript", "Mobile", "Web"]
categories: ["Android", "Development", "JavaScript", "Mobile", "Web"]
alias: ["/derekblog/post/2013/05/25/Getting-jQuery-Mobile-and-knockoutjs-to-play-together.aspx", "/derekblog/post/2013/05/25/getting-jquery-mobile-and-knockoutjs-to-play-together.aspx"]
---
<p>My current project is an HTML5 application to assemble text snippets for use in email or SMS messages &ndash; <a href="http://derekwilson.net/derekblog/post/2013/02/24/TextByNumbers.aspx" target="_blank">TextByNumbers</a>. I have to say that the experience has been pretty good. The two main frameworks I used were <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> and <a href="http://knockoutjs.com/" target="_blank">knockout.js</a>. I said at the time I would do a separate post about getting them to play nicely together, and here it is.</p><!--more-->
<p>First of all I started to use the jQuery Mobile ListView for everything because it looked so cool and was very easy to get going. However I soon found that I was trying to twist the ListView beyond what it was intended to do. For instance one of the pages has a list where each item is a label, an edit field and a button. I did try to do this using a list view but it became very difficult to attach bindings to elements that were being dynamically generated by jQuery Mobile.. Instead I fell back to using what I would usually use to do this &ndash; a knockout.js foreach</p>
<pre>&lt;div id='tokens'&gt;
&lt;!-- ko foreach: userTokenStorageContainer.persistentArray --&gt; 
  &lt;div class="ui-bar ui-bar-a" data-type="horizontal"&gt;
	&lt;div data-mini="false" data-bind="text: name"&gt;&lt;/div&gt;
	&lt;input type="text" data-bind="value: value"/&gt;
	&lt;div data-role="controlgroup" data-type="horizontal" data-mini="true"&gt;
		&lt;a href="#" data-bind="click: $root.removeToken" data-theme="b" data-role="button" data-icon="delete" data-iconpos="notext"&gt;Delete&lt;/a&gt;
	&lt;/div&gt;
  &lt;/div&gt;
&lt;!-- /ko --&gt;
&lt;/div&gt;</pre>
<p>All was good the generated page looked like this</p>
<p><a href="/images/tokens.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="tokens" src="/images/tokens_thumb.png" alt="tokens" width="179" height="244" border="0" /></a></p>
<p>However if I dynamically populated the bound object userTokenStorageContainer.persistentArray then the page would not refresh properly</p>
<p><a href="/images/bad%20refresh.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="bad refresh" src="/images/bad%20refresh_thumb.png" alt="bad refresh" width="182" height="244" border="0" /></a></p>
<p>This was a recurring problem as jQuery Mobile would render correctly when bound to knockout.js objects but if those object were then updated the display would not refresh. Luckily there was comparatively few operations that would update the data so I could manually ask jQuery Mobile to refresh the display like this</p>
<pre>self.addFromMessage = function () {
  var numberOfTokens = self.tokenProcessor.tokens().length;
  for (var tokenIndex = 0; tokenIndex &lt; numberOfTokens; tokenIndex++) {
  self.userTokenStorageContainer.addItem(
      new UserToken(
        self.tokenProcessor.tokens()[tokenIndex].name(),
        self.tokenProcessor.tokens()[tokenIndex].value()
      )
    )
  };
  self.refreshTokens();
};


self.refreshTokens = function () {
  // force JQM to update UI
  $('#tokens').trigger('create');
};</pre>
<p>The main issue is which jQuery Mobile method / event to use to get the page to refresh correctly. For ListViews we need to call refresh like this</p>
<pre>$(listview).listview('refresh');</pre>
<p>And other times it is necessary to trigger the page create like this</p>
<pre>if ($.mobile.activePage) {
  $.mobile.activePage.trigger('pagecreate');
}</pre>
<p>Another problem was page navigation. On the same page I needed the Message button to go to another page but also persist the bound data objects. At first I bound the button to this javascript</p>
<pre>self.gotoMessage = function () {
  self.saveAll();
  $.mobile.changePage("message.html");    
};</pre>
<p>However jQuery Mobile was being too clever in the way it did the page navigation meaning that the knockout bindings were not being run.</p>
<p><a href="/images/bad.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="bad" src="/images/bad_thumb.png" alt="bad" width="179" height="244" border="0" /></a></p>
<p>Going old school in the javascript</p>
<pre>self.gotoMessage = function () {
  self.saveAll();
  location.href = "message.html";
};</pre>
<p>Gave the correct page</p>
<p><a href="/images/good.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="good" src="/images/good_thumb.png" alt="good" width="179" height="244" border="0" /></a></p>
<p>So jQuery Mobile and knowckout.js can play well together but some care is needed.</p>
